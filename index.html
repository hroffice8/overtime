<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Review Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }
    
    /* CUSTOM STYLES */
    .sub-label { display: block; font-weight: normal; color: #2563eb; font-size: 12px; margin-bottom: 4px; }
    
    /* SUCCESS ANIMATION */
    .checkmark-circle { width: 80px; height: 80px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; }
    .checkmark { color: #16a34a; font-size: 40px; }
  </style>
</head>
<body class="bg-gray-100 p-4">

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzFvjfUXA9seOb8x1y7zCC_F-reZbTTF_1tTiRPMPk9p7SmV-ZD1YRDpNzNsXolSEdBEQ/exec"; 
  </script>
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md my-8">
    
    <h2 id="mainTitle" class="text-2xl font-bold mb-6 text-gray-800 border-b pb-4">Attendance Review Portal</h2>
    
    <div id="searchSection" class="flex gap-4 mb-6">
      <input type="text" id="searchInput" placeholder="Enter Employee ID" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      <button onclick="searchEmployee()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-bold transition">Search</button>
    </div>
    
    <div id="loader" class="hidden text-center py-8">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
      <p class="text-gray-500 mt-2">Searching records...</p>
    </div>

    <div id="resultArea" class="hidden">
      
      <div class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-100 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        <div><span class="text-gray-500 block text-xs uppercase font-bold">ID</span><strong id="dispId" class="text-gray-800 text-lg"></strong></div>
        <div><span class="text-gray-500 block text-xs uppercase font-bold">Name</span><strong id="dispName" class="text-gray-800"></strong></div>
        <div><span class="text-gray-500 block text-xs uppercase font-bold">Designation</span><strong id="dispDesig" class="text-gray-800"></strong></div>
        <div><span class="text-gray-500 block text-xs uppercase font-bold">Department</span><strong id="dispDept" class="text-gray-800"></strong></div>
      </div>

      <div class="overflow-x-auto mb-8 border rounded-lg shadow-sm">
        <table class="w-full text-sm text-left text-gray-700">
          <thead class="text-xs text-white uppercase bg-blue-900">
            <tr>
              <th class="px-4 py-3">Date</th>
              <th class="px-4 py-3">Day</th>
              <th class="px-4 py-3">Sch In</th>
              <th class="px-4 py-3">Sch Out</th>
              <th class="px-4 py-3">In</th>
              <th class="px-4 py-3">Out</th>
              <th class="px-4 py-3">Total</th>
              <th class="px-4 py-3">Status</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-gray-200"></tbody>
        </table>
      </div>

      <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-sm">
        <h3 id="formTitle" class="text-lg font-bold text-gray-800">Summary</h3>
        <p class="text-sm text-gray-600 mb-6 font-semibold border-b pb-2">
          Common Holiday and Weekend = 04 Days <br> Weekdays/Working Days = 26 Days
        </p>
        
        <input type="hidden" id="empId">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <label class="block font-bold text-gray-700">Overtime Duty Days (per week)</label>
            <span class="sub-label">[সপ্তাহে কয়দিন উনাকে ওভারটাইম ডিউটির অনুমতি দিয়েছিলেন?]</span>
            <input type="number" id="otDutyDays" class="w-full p-2 border border-gray-300 rounded mt-1 focus:ring-2 focus:ring-blue-500 outline-none" step="0.5" placeholder="0">
          </div>
          <div>
            <label class="block font-bold text-gray-700">Total Overtime Hours</label>
            <span class="sub-label">[সর্বমোট ওভারটাইম ঘন্টা]</span>
            <input type="number" id="totalOtHours" class="w-full p-2 border border-gray-300 rounded mt-1 focus:ring-2 focus:ring-blue-500 outline-none" step="0.5" placeholder="0">
          </div>

          <div>
            <label class="block font-bold text-gray-700">Total Holiday/Weekend Days</label>
            <span class="sub-label">[এই মাসে উনার মোট হলিডে বা উইকেন্ড ডিউটি কতদিন?]</span>
            <input type="number" id="totalHolidayDays" class="w-full p-2 border border-gray-300 rounded mt-1 focus:ring-2 focus:ring-blue-500 outline-none" step="0.5" placeholder="0">
          </div>
          <div>
            <label class="block font-bold text-gray-700">Total Holiday Hours (Max 8/day)</label>
            <span class="sub-label">[এই মাসে উনার মোট হলিডে বা উইকেন্ড ডিউটি কতঘন্টা?]</span>
            <input type="number" id="totalHolidayHours" class="w-full p-2 border border-gray-300 rounded mt-1 focus:ring-2 focus:ring-blue-500 outline-none" step="0.5" placeholder="0">
          </div>
        </div>

        <div class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded text-sm text-gray-800">
           <h4 class="font-bold text-red-700 mb-2">গুরুত্বপূর্ণ নোট:</h4>
           <ul class="list-decimal pl-5 space-y-1">
            <li>যেকোনো হলিডে বা ওভারটাইম ডিউটি বিলের ক্ষেত্রে উপস্থিতির পাঞ্চ বাধ্যতামূলক।</li>
            <li>সুপারভাইজারের রিকমেন্ডেশন অবশ্যই উক্ত এমপ্লয়ীর জন্য ম্যানেজমেন্ট প্রদত্ত অনুমোদনের সঙ্গে সামঞ্জস্যপূর্ণ হতে হবে।</li>
            <li>উপস্থিতির পাঞ্চ থাকলেও সুপারভাইজার এর রিকমেন্ডেশন ব্যতীত হলিডে বা ওভারটাইম ডিউটি বিল প্রদান করা হবে না।</li>
           </ul>
        </div>

        <label class="flex items-center gap-3 mb-6 font-bold cursor-pointer p-3 bg-white border rounded hover:bg-gray-50">
          <input type="checkbox" id="termsCheckbox" class="w-5 h-5 text-blue-600"> 
          <span>I have read and agreed to the above terms.</span>
        </label>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-6">
           <div>
             <label class="block font-bold text-gray-700 mb-1">Supervisor ID</label>
             <input type="text" id="supervisorId" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter Your ID">
           </div>
           <div>
             <label class="block font-bold text-gray-700 mb-1">Supervisor Email (For OTP)</label>
             <input type="email" id="supervisorEmail" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="supervisor@company.com">
           </div>
        </div>

        <div class="mt-8 text-right">
          <button onclick="initiateOtp()" id="otpBtn" class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 font-bold shadow-md transition transform hover:scale-105">Request OTP & Submit</button>
        </div>
      </div>
    </div>

    <div id="successPage" class="hidden text-center py-16">
      <div class="checkmark-circle">
        <span class="checkmark">✔</span>
      </div>
      <h2 class="text-3xl font-bold text-gray-800 mb-2">Success!</h2>
      <p class="text-gray-600 text-lg mb-8">Your inputs have been received successfully.</p>
      <button onclick="location.reload()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-bold shadow-md transition">Review Another Employee</button>
    </div>

  </div>

  <div id="otpModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex justify-center items-center z-50 backdrop-blur-sm">
    <div class="bg-white p-8 rounded-xl text-center w-96 shadow-2xl transform transition-all scale-100">
      <h3 class="text-2xl font-bold mb-2 text-gray-800">Enter Verification Code</h3>
      <p class="text-sm text-gray-500 mb-6">We sent a 6-digit code to your email.</p>
      
      <input type="text" id="otpInput" class="text-center text-4xl mb-6 font-bold border-b-2 border-gray-300 focus:border-blue-500 w-full py-2 tracking-[0.5em] outline-none" maxlength="6" placeholder="000000">
      
      <div id="timer" class="text-red-500 font-bold mb-6 text-lg">02:00</div>
      
      <div class="flex gap-3 justify-center">
        <button onclick="document.getElementById('otpModal').classList.add('hidden')" class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">Cancel</button>
        <button onclick="verifyOtp()" id="verifyBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow">Verify</button>
      </div>
    </div>
  </div>

  <script>
    // --- 1. SEARCH FUNCTION ---
    async function searchEmployee() {
      const id = document.getElementById('searchInput').value;
      if(!id) return alert("Please Enter an Employee ID");
      
      document.getElementById('loader').classList.remove('hidden');
      document.getElementById('resultArea').classList.add('hidden');
      document.getElementById('successPage').classList.add('hidden');
      
      try {
        const response = await fetch(`${API_URL}?action=search&id=${id}`);
        const res = await response.json();
        
        document.getElementById('loader').classList.add('hidden');
        if(!res.found) return alert("Employee ID Not Found in Database");

        // Populate Data
        document.getElementById('mainTitle').innerText = "Attendance Review: " + res.monthName;
        document.getElementById('formTitle').innerText = "Summary: " + res.dateRange;
        document.getElementById('dispId').innerText = res.info.id;
        document.getElementById('empId').value = res.info.id;
        document.getElementById('dispName').innerText = res.info.name;
        document.getElementById('dispDesig').innerText = res.info.designation;
        document.getElementById('dispDept').innerText = res.info.department;

        // Populate Table
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = res.records.map(r => 
          `<tr class="border-b hover:bg-gray-50"><td class="p-3">${r.date}</td><td>${r.day}</td><td>${r.schIn}</td><td>${r.schOut}</td><td>${r.chkIn}</td><td>${r.chkOut}</td><td>${r.total}</td><td>${r.status}</td></tr>`
        ).join('');
        
        document.getElementById('resultArea').classList.remove('hidden');

      } catch(e) { 
        document.getElementById('loader').classList.add('hidden');
        alert("Connection Error. Please check your internet or try again later.\n\nDetails: " + e); 
      }
    }

    // --- 2. SEND OTP ---
    async function initiateOtp() {
      const email = document.getElementById('supervisorEmail').value;
      const supId = document.getElementById('supervisorId').value;
      
      if(!document.getElementById('termsCheckbox').checked) return alert("Please read the notes and check the agreement box.");
      if(!supId) return alert("Please enter Supervisor ID.");
      if(!email.includes('@')) return alert("Please enter a valid email address.");

      // Check numeric fields
      const inputs = ['otDutyDays','totalOtHours','totalHolidayDays','totalHolidayHours'];
      for(let id of inputs) {
        if(document.getElementById(id).value === "") return alert("Please fill all numeric fields (enter 0 if none).");
      }

      const btn = document.getElementById('otpBtn');
      const originalText = btn.innerText;
      btn.innerText = "Sending Code..."; btn.disabled = true;

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'sendOtp', email: email })
        });
        const res = await response.json();

        btn.innerText = originalText; btn.disabled = false;
        
        if(res.success) {
          document.getElementById('otpModal').classList.remove('hidden');
          document.getElementById('otpInput').value = "";
          startTimer(120);
        } else {
          alert("Error sending email: " + res.message);
        }
      } catch(e) {
        btn.innerText = originalText; btn.disabled = false;
        alert("System Error: " + e);
      }
    }

    // --- 3. VERIFY OTP ---
    async function verifyOtp() {
      const btn = document.getElementById('verifyBtn');
      btn.innerText = "Verifying..."; btn.disabled = true;
      
      const data = {
        action: 'verify',
        email: document.getElementById('supervisorEmail').value,
        otp: document.getElementById('otpInput').value,
        formData: {
          empId: document.getElementById('empId').value,
          supId: document.getElementById('supervisorId').value,
          otDutyDays: document.getElementById('otDutyDays').value,
          totalOtHours: document.getElementById('totalOtHours').value,
          totalHolidayDays: document.getElementById('totalHolidayDays').value,
          totalHolidayHours: document.getElementById('totalHolidayHours').value
        }
      };

      try {
        const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
        const res = await response.json();

        if(res.success) {
          // Success Flow
          document.getElementById('otpModal').classList.add('hidden');
          document.getElementById('resultArea').classList.add('hidden');
          document.getElementById('searchSection').classList.add('hidden');
          document.getElementById('mainTitle').classList.add('hidden');
          document.getElementById('successPage').classList.remove('hidden');
        } else {
          alert("❌ " + res.message);
          btn.innerText = "Verify"; btn.disabled = false;
        }
      } catch(e) {
        alert("Verification Failed: " + e);
        btn.innerText = "Verify"; btn.disabled = false;
      }
    }

    // --- UTILS ---
    let timerInterval;
    function startTimer(duration) {
      let timer = duration;
      const display = document.getElementById('timer');
      clearInterval(timerInterval);
      
      timerInterval = setInterval(() => {
        let m = parseInt(timer / 60, 10);
        let s = parseInt(timer % 60, 10);
        
        m = m < 10 ? "0" + m : m;
        s = s < 10 ? "0" + s : s;
        
        display.textContent = m + ":" + s;

        if (--timer < 0) {
          clearInterval(timerInterval);
          display.textContent = "EXPIRED";
          document.getElementById('verifyBtn').disabled = true;
        }
      }, 1000);
    }
  </script>
</body>
</html>
